name: CD - Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  SERVICE_NAME: serena
  REPO_NAME: serena-repo

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOY_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set image tag
        id: meta
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}"
          TAG="${IMAGE}:${{ github.sha }}"
          echo "tags=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image
        run: |
          docker build -t ${{ steps.meta.outputs.tags }} .
          docker push ${{ steps.meta.outputs.tags }}

  deploy-backend:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOY_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy backend to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-backend \
            --image=${{ needs.build-and-push.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --no-allow-unauthenticated \
            --service-account=${{ secrets.BACKEND_RUNTIME_SA_EMAIL }} \
            --min-instances=0 \
            --max-instances=10 \
            --memory=512Mi \
            --cpu=1 \
            --port=8080 \
            --vpc-connector=projects/${{ env.PROJECT_ID }}/locations/${{ env.REGION }}/connectors/${{ vars.VPC_CONNECTOR_NAME || 'serena-connector' }} \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME }} \
            --set-secrets=DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest,GCS_BUCKET=GCS_BUCKET:latest \
            --set-env-vars=CLOUD_SQL_CONNECTION_NAME=${{ secrets.CLOUD_SQL_CONNECTION_NAME }},GCP_PROJECT_ID=${{ env.PROJECT_ID }},ENVIRONMENT=production

  deploy-frontend:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOY_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy frontend to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-frontend \
            --image=${{ needs.build-and-push.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --service-account=${{ secrets.FRONTEND_RUNTIME_SA_EMAIL }} \
            --min-instances=0 \
            --max-instances=10 \
            --memory=256Mi \
            --cpu=1 \
            --port=3000

      - name: Apply Cloud Armor policy to frontend
        run: |
          # Cloud Armor requires a backend service (NEG-based).
          # If using a load balancer in front of Cloud Run, attach the policy:
          ARMOR_POLICY="${{ vars.ARMOR_POLICY_NAME || 'serena-security-policy' }}"
          BACKEND_SERVICE="${{ env.SERVICE_NAME }}-frontend-backend"
          if gcloud compute backend-services describe "${BACKEND_SERVICE}" --global &>/dev/null; then
            gcloud compute backend-services update "${BACKEND_SERVICE}" \
              --global \
              --security-policy="${ARMOR_POLICY}"
            echo "Cloud Armor policy ${ARMOR_POLICY} attached to ${BACKEND_SERVICE}."
          else
            echo "::warning::Backend service ${BACKEND_SERVICE} not found. Cloud Armor policy must be attached manually if using a load balancer."
          fi

  verify:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOY_SA_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify backend deployment
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-backend --region=${{ env.REGION }} --format='value(status.url)')
          echo "Backend URL: ${URL}"
          # Backend requires IAM auth; use identity token for health check
          TOKEN=$(gcloud auth print-identity-token --audiences="${URL}")
          STATUS=$(curl -s -o /dev/null -w '%{http_code}' -H "Authorization: Bearer ${TOKEN}" "${URL}/health" || true)
          if [ "${STATUS}" = "200" ]; then
            echo "Backend health check passed."
          else
            echo "::warning::Backend health check returned status ${STATUS}"
          fi

      - name: Verify frontend deployment
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-frontend --region=${{ env.REGION }} --format='value(status.url)')
          echo "Frontend URL: ${URL}"
          STATUS=$(curl -s -o /dev/null -w '%{http_code}' "${URL}" || true)
          if [ "${STATUS}" = "200" ]; then
            echo "Frontend health check passed."
          else
            echo "::warning::Frontend health check returned status ${STATUS}"
          fi
